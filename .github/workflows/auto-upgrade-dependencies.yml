name: Auto Upgrade Dependencies

on:
    schedule:
        - cron: "0 6 * * *" # Daily at 6 AM UTC
    workflow_dispatch:
        inputs:
            dry_run:
                description: "Dry run (don't create PR)"
                required: false
                type: boolean
                default: false

concurrency:
    group: ${{ github.workflow }}
    cancel-in-progress: true

env:
    CARGO_TERM_COLOR: always

permissions:
    contents: write
    pull-requests: write

jobs:
    build-cargo-upgrade:
        name: Build cargo-upgrade (${{ matrix.os }})
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: true
            matrix:
                os: [macos-latest, ubuntu-latest, windows-latest]

        steps:
            - uses: dtolnay/rust-toolchain@stable

            - uses: actions/checkout@v4

            - name: Setup cargo-upgrade
              uses: BSteffaniak/cache-artifact@master
              with:
                  repo: https://github.com/BSteffaniak/cargo-edit
                  command: cargo install -f cargo-edit --git https://github.com/BSteffaniak/cargo-edit --branch add-skip-git-dependencies
                  shell: bash
                  output-path: ~/.cargo/bin/cargo-upgrade${{ matrix.os == 'windows-latest' && '.exe' || '' }}
                  artifact-name: cargo-upgrade-${{ matrix.os }}-binary
                  cache-key-prefix: cargo-upgrade
                  make-executable: true
                  verify-command: --help

            - uses: actions/upload-artifact@master
              if: ${{ matrix.os == 'macos-latest' }}
              with:
                  name: cargo-upgrade-macos
                  path: ~/.cargo/bin/cargo-upgrade

            - uses: actions/upload-artifact@master
              if: ${{ matrix.os == 'ubuntu-latest' }}
              with:
                  name: cargo-upgrade-ubuntu
                  path: ~/.cargo/bin/cargo-upgrade

            - uses: actions/upload-artifact@master
              if: ${{ matrix.os == 'windows-latest' }}
              with:
                  name: cargo-upgrade.exe
                  path: ~/.cargo/bin/cargo-upgrade.exe

    build-cargo-machete:
        name: Build cargo-machete (${{ matrix.os }})
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: true
            matrix:
                os: [macos-latest, ubuntu-latest, windows-latest]

        steps:
            - uses: dtolnay/rust-toolchain@stable

            - uses: actions/checkout@v4

            - name: Setup cargo-machete
              uses: BSteffaniak/cache-artifact@master
              with:
                  repo: https://github.com/BSteffaniak/cargo-machete
                  command: cargo install --git https://github.com/BSteffaniak/cargo-machete --branch ignored-dirs cargo-machete
                  shell: bash
                  output-path: ~/.cargo/bin/cargo-machete${{ matrix.os == 'windows-latest' && '.exe' || '' }}
                  artifact-name: cargo-machete-${{ matrix.os }}-binary
                  cache-key-prefix: cargo-machete
                  make-executable: true
                  verify-command: --version

            - uses: actions/upload-artifact@master
              if: ${{ matrix.os == 'macos-latest' }}
              with:
                  name: cargo-machete-macos
                  path: ~/.cargo/bin/cargo-machete

            - uses: actions/upload-artifact@master
              if: ${{ matrix.os == 'ubuntu-latest' }}
              with:
                  name: cargo-machete-ubuntu
                  path: ~/.cargo/bin/cargo-machete

            - uses: actions/upload-artifact@master
              if: ${{ matrix.os == 'windows-latest' }}
              with:
                  name: cargo-machete.exe
                  path: ~/.cargo/bin/cargo-machete.exe

    upgrade-dependencies:
        name: Upgrade Dependencies
        runs-on: ubuntu-latest
        needs: [build-cargo-upgrade]
        outputs:
            has-changes: ${{ steps.check-changes.outputs.has-changes }}
            branch-name: ${{ steps.branch.outputs.branch_name }}

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - uses: dtolnay/rust-toolchain@stable

            - uses: actions/download-artifact@master
              with:
                  name: cargo-upgrade-ubuntu
                  path: ~/.cargo/bin

            - name: Make cargo-upgrade executable
              shell: bash
              run: chmod +x ~/.cargo/bin/cargo-upgrade

            - name: Create branch
              id: branch
              run: |
                  BRANCH_NAME="auto-upgrade-deps-$(date +%Y%m%d)-${{ github.run_id }}"
                  git checkout -b "$BRANCH_NAME"
                  echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

            - name: Run cargo upgrade (compatible)
              run: |
                  ~/.cargo/bin/cargo-upgrade upgrade --compatible --verbose

            - name: Run cargo upgrade (incompatible)
              run: |
                  ~/.cargo/bin/cargo-upgrade upgrade --incompatible --verbose
              continue-on-error: true

            - name: Update Cargo.lock
              run: cargo update

            - name: Check for changes
              id: check-changes
              run: |
                  if git diff --quiet; then
                      echo "has-changes=false" >> $GITHUB_OUTPUT
                  else
                      echo "has-changes=true" >> $GITHUB_OUTPUT
                  fi

            - name: Commit changes
              if: steps.check-changes.outputs.has-changes == 'true'
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add -A
                  git commit -m "build(deps): automated dependency upgrades"
                  git push -u origin ${{ steps.branch.outputs.branch_name }}

    determine-packages:
        name: Determine Packages
        runs-on: ubuntu-latest
        needs: [upgrade-dependencies]
        if: needs.upgrade-dependencies.outputs.has-changes == 'true'
        outputs:
            matrix: ${{ steps.analyze.outputs.matrix }}

        steps:
            - uses: actions/checkout@v4
              with:
                  ref: ${{ needs.upgrade-dependencies.outputs.branch-name }}
                  fetch-depth: 0

            - uses: dtolnay/rust-toolchain@stable

            - name: Generate matrix
              id: analyze
              uses: MoosicBox/MoosicBox/.github/actions/clippier@master
              with:
                  command: features
                  workspace-path: .
                  chunked: 15
                  max-parallel: 256
                  spread: true
                  randomize: true
                  seed: ${{ github.run_id }}
                  skip-features: fail-on-warnings
                  transform-name-regex: "^worktree_setup_"
                  force-full-matrix-condition: "true"

    validate-upgrades:
        name: Validate Upgrades - ${{ matrix.package.name }}
        runs-on: ${{ matrix.package.os }}
        needs: [upgrade-dependencies, build-cargo-machete, determine-packages]
        if: needs.upgrade-dependencies.outputs.has-changes == 'true'
        strategy:
            fail-fast: false
            matrix:
                package: ${{ fromJson(needs.determine-packages.outputs.matrix) }}

        steps:
            - uses: actions/checkout@v4
              with:
                  ref: ${{ needs.upgrade-dependencies.outputs.branch-name }}

            - name: Setup CI environment
              uses: MoosicBox/MoosicBox/.github/actions/clippier@master
              with:
                  command: setup
                  package-json: ${{ toJson(matrix.package) }}
                  skip-checkout: "true"
                  rust-components: "rustfmt, clippy"

            - name: Download cargo-machete
              uses: actions/download-artifact@master
              with:
                  name: ${{ matrix.package.os == 'windows-latest' && 'cargo-machete.exe' || matrix.package.os == 'macos-latest' && 'cargo-machete-macos' || 'cargo-machete-ubuntu' }}
                  path: ~/.cargo/bin

            - name: Make cargo-machete executable
              shell: bash
              run: chmod +x ~/.cargo/bin/cargo-machete${{ matrix.package.os == 'windows-latest' && '.exe' || '' }}

            - name: Validate package
              uses: MoosicBox/MoosicBox/.github/actions/clippier@master
              with:
                  command: run-matrix
                  run-matrix-package-json: ${{ toJson(matrix.package) }}
                  run-matrix-steps: |
                      clippy:
                        commands: |
                          cargo clippy --all-targets --no-default-features {{clippier.feature-flags}} -- -D warnings
                        label: "Clippy"
                        strategy: "sequential"

                      tests:
                        commands: |
                          cargo test --no-default-features {{clippier.feature-flags}} --no-fail-fast
                        label: "Tests"
                        strategy: "sequential"

                      machete:
                        commands: |
                          ~/.cargo/bin/cargo-machete${{ matrix.package.os == 'windows-latest' && '.exe' || '' }} --with-metadata {{matrix.package.path}}
                        label: "Machete"
                        strategy: "combined"
                        working-directory: "."

                  run-matrix-auto-upload: true

    create-pr:
        name: Create Pull Request
        runs-on: ubuntu-latest
        needs: [upgrade-dependencies, validate-upgrades]
        if: |
            always() &&
            needs.upgrade-dependencies.outputs.has-changes == 'true' &&
            needs.validate-upgrades.result == 'success' &&
            !inputs.dry_run

        steps:
            - uses: actions/checkout@v4
              with:
                  ref: ${{ needs.upgrade-dependencies.outputs.branch-name }}
                  fetch-depth: 0

            - name: Create PR
              uses: MoosicBox/MoosicBox/.github/actions/claude-checker@master
              with:
                  command: create-pr
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  branch_name: ${{ needs.upgrade-dependencies.outputs.branch-name }}
                  pr_base_branch: master
                  pr_title: "Automated Dependency Upgrades"
                  pr_body: |
                      This PR contains automated dependency upgrades.

                      ## Validation
                      All packages have been validated:
                      - Clippy passes with no warnings
                      - All tests pass
                      - No unused dependencies (cargo-machete)

                      ---
                      *This PR was automatically generated by the Auto Upgrade Dependencies workflow.*
                  pr_labels: automated,dependencies
