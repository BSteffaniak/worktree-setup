name: Build and Test

on:
    push:
        branches: ["master"]
        paths:
            - ".github/workflows/build-and-test.yml"
            - "packages/**"
            - "**/*.toml"
            - "**/Cargo.lock"
            - "!**/*.md"
            - "!**/LICENSE"
            - "!**/.gitignore"
    pull_request:
        branches: ["master"]
    workflow_dispatch:
        inputs:
            seed:
                description: "Random seed for deterministic feature randomization"
                required: false
                type: string
            packages:
                description: "Comma-separated list of packages to build"
                required: false
                type: string
                default: ""

concurrency:
    group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.run_id }}
    cancel-in-progress: ${{ github.event_name == 'pull_request' }}

env:
    CARGO_TERM_COLOR: always

jobs:
    determine-affected-packages:
        name: Analyze Changes
        runs-on: ubuntu-latest
        outputs:
            matrix: ${{ steps.analyze.outputs.matrix }}
            has-changes: ${{ steps.analyze.outputs.has-changes }}
            reasoning: ${{ steps.analyze.outputs.reasoning }}
            randomization-seed: ${{ steps.seed.outputs.value }}

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Generate seed
              id: seed
              run: |
                  if [[ -n "${{ github.event.inputs.seed }}" ]]; then
                      echo "value=${{ github.event.inputs.seed }}" >> $GITHUB_OUTPUT
                  else
                      echo "value=$(date +%s)$RANDOM" >> $GITHUB_OUTPUT
                  fi

            - uses: dtolnay/rust-toolchain@stable

            - name: Analyze changes and generate comprehensive matrix
              id: analyze
              uses: MoosicBox/MoosicBox/.github/actions/clippier@master
              with:
                  command: features
                  workspace-path: .

                  packages: ${{ github.event.inputs.packages }}
                  chunked: 15
                  max-parallel: 256
                  spread: true
                  randomize: true
                  seed: ${{ steps.seed.outputs.value }}
                  skip-features: fail-on-warnings
                  include-reasoning: true
                  transform-name-regex: "^worktree_setup_"
                  git-strategy: workflow-history
                  ignore: |
                      **/*.md
                      **/*.txt
                      **/LICENSE
                      **/.gitignore
                  inject-reasoning: |
                      ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.packages && format('Manual workflow dispatch - selected packages: {0}', github.event.inputs.packages) || '' }}
                      ${{ github.event_name == 'workflow_dispatch' && !github.event.inputs.packages && 'Manual workflow dispatch - all packages included' || '' }}
                  inject-reasoning-condition: ${{ github.event_name == 'workflow_dispatch' }}
                  force-full-matrix-condition: ${{ github.event_name == 'workflow_dispatch' }}

                  generate-summary: true
                  summary-title: "Smart CI Analysis Summary"
                  summary-event-name: ${{ github.event_name }}
                  summary-ref-name: ${{ github.ref_name }}
                  summary-trigger-input: ${{ github.event.inputs.packages }}
                  summary-show-trigger: true
                  summary-show-jobs-details: true
                  summary-include-seed: true

    cargo-deny:
        name: Cargo Deny
        runs-on: ubuntu-latest
        needs: [determine-affected-packages]
        if: ${{ needs.determine-affected-packages.outputs.has-changes == 'true' }}

        steps:
            - uses: actions/checkout@v4

            - uses: EmbarkStudios/cargo-deny-action@v2
              with:
                  command: check

    build-cargo-machete:
        name: Build Cargo Machete (${{ matrix.os }})
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: true
            matrix:
                os: [macos-latest, ubuntu-latest, windows-latest]

        steps:
            - uses: dtolnay/rust-toolchain@stable

            - uses: actions/checkout@v4

            - name: Setup cargo-machete
              uses: BSteffaniak/cache-artifact@master
              with:
                  repo: https://github.com/BSteffaniak/cargo-machete
                  command: cargo install --git https://github.com/BSteffaniak/cargo-machete --branch ignored-dirs cargo-machete
                  shell: bash
                  output-path: ~/.cargo/bin/cargo-machete${{ matrix.os == 'windows-latest' && '.exe' || '' }}
                  artifact-name: cargo-machete-${{ matrix.os }}-binary
                  cache-key-prefix: cargo-machete
                  make-executable: true
                  verify-command: --version

            - uses: actions/upload-artifact@master
              if: ${{ matrix.os == 'macos-latest' }}
              with:
                  name: cargo-machete-macos
                  path: ~/.cargo/bin/cargo-machete

            - uses: actions/upload-artifact@master
              if: ${{ matrix.os == 'ubuntu-latest' }}
              with:
                  name: cargo-machete-ubuntu
                  path: ~/.cargo/bin/cargo-machete

            - uses: actions/upload-artifact@master
              if: ${{ matrix.os == 'windows-latest' }}
              with:
                  name: cargo-machete.exe
                  path: ~/.cargo/bin/cargo-machete.exe

    validate-feature-propagation:
        name: Validate Feature Propagation
        runs-on: ubuntu-latest
        needs: [determine-affected-packages]
        if: ${{ needs.determine-affected-packages.outputs.has-changes == 'true' }}

        steps:
            - uses: actions/checkout@v4

            - uses: dtolnay/rust-toolchain@stable

            - name: Validate feature propagation
              uses: MoosicBox/MoosicBox/.github/actions/clippier@master
              with:
                  command: validate-feature-propagation
                  workspace-path: .
                  skip-on-no-changes: false

    build:
        name: Build ${{ matrix.package.name }}
        runs-on: ${{ matrix.package.os }}
        needs: [determine-affected-packages, build-cargo-machete]
        if: ${{ needs.determine-affected-packages.outputs.has-changes == 'true' }}
        strategy:
            fail-fast: false
            matrix:
                package: ${{ fromJson(needs.determine-affected-packages.outputs.matrix) }}

        steps:
            - uses: actions/checkout@v4

            - name: Setup CI environment
              uses: MoosicBox/MoosicBox/.github/actions/clippier@master
              with:
                  command: setup
                  package-json: ${{ toJson(matrix.package) }}
                  skip-checkout: "true"
                  rust-components: "rustfmt, clippy, llvm-tools-preview"

            - name: Download cargo-machete
              uses: actions/download-artifact@master
              with:
                  name: ${{ matrix.package.os == 'windows-latest' && 'cargo-machete.exe' || matrix.package.os == 'macos-latest' && 'cargo-machete-macos' || 'cargo-machete-ubuntu' }}
                  path: ~/.cargo/bin

            - name: Make cargo-machete executable
              shell: bash
              run: chmod +x ~/.cargo/bin/cargo-machete${{ matrix.package.os == 'windows-latest' && '.exe' || '' }}

            - name: Install cargo-llvm-cov
              uses: taiki-e/install-action@cargo-llvm-cov

            - name: Test suite for ${{ matrix.package.name }}
              id: test-suite
              uses: MoosicBox/MoosicBox/.github/actions/clippier@master
              with:
                  command: run-matrix
                  run-matrix-package-json: ${{ toJson(matrix.package) }}
                  run-matrix-steps: |
                      clear-target-1:
                        commands: rm -rf target

                      clippy:
                        commands: |
                          {{if matrix.package.env}}{{matrix.package.env}} {{endif}}cargo{{if matrix.package.nightly}} +nightly{{endif}} clippy {{if runner.debug}}-vv {{endif}}--all-targets --no-default-features {{clippier.feature-flags}}{{if matrix.package.cargo}} {{matrix.package.cargo}}{{endif}} -- -D warnings
                        label: "Clippy"
                        strategy: "sequential"

                      tests:
                        commands: |
                          {{if matrix.package.env}}{{matrix.package.env}} {{endif}}cargo{{if matrix.package.nightly}} +nightly{{endif}} llvm-cov test --no-report {{if runner.debug}}-vv {{endif}}--no-default-features {{clippier.feature-flags}}{{if matrix.package.cargo}} {{matrix.package.cargo}}{{endif}} --no-fail-fast
                        label: "Tests"
                        strategy: "sequential"

                      doctests:
                        commands: |
                          PACKAGE_PATH="{{matrix.package.path}}"
                          PACKAGE_PATH="${PACKAGE_PATH#./}"
                          if ! cargo metadata --format-version=1 --no-deps | jq -e ".packages[] | select(.manifest_path | contains(\"${PACKAGE_PATH}/Cargo.toml\")) | .targets[] | select(.kind[] | contains(\"lib\"))" > /dev/null 2>&1; then
                              echo "Skipping doctests for {{matrix.package.name}} - no library target found"
                              exit 0
                          fi
                          {{if matrix.package.env}}{{matrix.package.env}} {{endif}}cargo{{if matrix.package.nightly}} +nightly{{endif}} test --doc {{if runner.debug}}-vv {{endif}}--no-default-features {{clippier.feature-flags}}{{if matrix.package.cargo}} {{matrix.package.cargo}}{{endif}} --no-fail-fast
                        label: "Doctests"
                        strategy: "sequential"

                      clear-target-2:
                        commands: rm -rf target

                      format:
                        commands: |
                          cargo{{if matrix.package.nightly}} +nightly{{endif}}{{if runner.debug}} -vv{{endif}} fmt --all -- --check
                        label: "Format Check"
                        strategy: "combined"

                      machete:
                        commands: |
                          ~/.cargo/bin/cargo-machete${{ matrix.package.os == 'windows-latest' && '.exe' || '' }} --with-metadata {{matrix.package.path}}
                        label: "Dependency Validation (Machete)"
                        strategy: "combined"
                        working-directory: "."

                  run-matrix-debug-shells: "fish,bash"
                  run-matrix-auto-upload: true

    generate-failures-summary:
        name: Generate Workflow Failures Summary
        runs-on: ubuntu-latest
        needs: [build]
        if: always()

        steps:
            - uses: actions/checkout@v4

            - name: Download failure artifacts
              uses: actions/download-artifact@v4
              with:
                  pattern: test-results-*
                  path: ./failure-data
                  merge-multiple: true

            - name: Generate workflow-wide failures summary
              id: failures-summary
              uses: MoosicBox/MoosicBox/.github/actions/clippier@master
              with:
                  command: run-matrix-aggregate-failures
                  run-matrix-working-directory: ./failure-data
                  run-matrix-summary-auto-expand: never
                  run-matrix-aggregate-output-file: ./failures-summary.md

            - name: Upload failures summary artifact
              if: always() && steps.failures-summary.outputs.aggregate-summary-path != ''
              uses: actions/upload-artifact@v4
              with:
                  name: workflow-failures-summary
                  path: ${{ steps.failures-summary.outputs.aggregate-summary-path }}
                  if-no-files-found: ignore
