name: Claude Issue Handler

on:
    issue_comment:
        types: [created]
    issues:
        types: [opened]

permissions:
    contents: write
    pull-requests: write
    issues: write
    id-token: write
    actions: read

jobs:
    check-authorization:
        name: Check Authorization
        runs-on: ubuntu-latest
        if: |
            (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
            (github.event_name == 'issues' && contains(github.event.issue.body, '@claude'))
        outputs:
            is-authorized: ${{ steps.check.outputs.is-authorized }}

        steps:
            - name: Check organization membership
              id: check
              uses: actions/github-script@v7
              with:
                  script: |
                      const actor = context.actor;
                      const owner = context.repo.owner;

                      if (actor === owner) {
                          core.setOutput('is-authorized', 'true');
                          return;
                      }

                      try {
                          const { data: membership } = await github.rest.orgs.checkMembershipForUser({
                              org: owner,
                              username: actor
                          });
                          core.setOutput('is-authorized', 'true');
                      } catch (error) {
                          core.setOutput('is-authorized', 'false');
                      }

    handle-issue:
        name: Handle Issue
        runs-on: ubuntu-latest
        needs: check-authorization
        if: needs.check-authorization.outputs.is-authorized == 'true'

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Post acknowledgment
              id: ack
              uses: actions/github-script@v7
              with:
                  script: |
                      const { data: comment } = await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: context.issue.number,
                          body: 'ðŸ‘€ Looking into this...'
                      });
                      core.setOutput('comment-id', comment.id);

            - name: Create branch
              id: branch
              uses: MoosicBox/MoosicBox/.github/actions/claude-checker@master
              with:
                  command: create-branch
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  branch_prefix: claude-issue-${{ github.event.issue.number }}

            - name: Run Claude
              id: claude
              uses: MoosicBox/MoosicBox/.github/actions/claude-checker@master
              with:
                  command: check
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  claude_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
                  prompt_template: issue
                  template_vars: |
                      issue_number: ${{ github.event.issue.number }}
                      issue_title: ${{ github.event.issue.title }}
                      issue_body: ${{ github.event.issue.body }}
                      comment_body: ${{ github.event.comment.body || '' }}
                  branch_name: ${{ steps.branch.outputs.branch_name }}
                  auto_commit: true
                  enable_resilient_push: true
                  enable_stream_watcher: true
                  stream_comment_id: ${{ steps.ack.outputs.comment-id }}
                  stream_comment_type: issue
                  enable_execution_details: true
                  acknowledgment_comment_id: ${{ steps.ack.outputs.comment-id }}
                  enable_coauthor_attribution: true
                  model: claude-opus-4-20250514

            - name: Create PR
              if: steps.claude.outputs.has_changes == 'true'
              uses: MoosicBox/MoosicBox/.github/actions/claude-checker@master
              with:
                  command: create-pr
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  branch_name: ${{ steps.branch.outputs.branch_name }}
                  pr_base_branch: master
                  pr_title: "Fix #${{ github.event.issue.number }}: ${{ github.event.issue.title }}"
                  pr_body: |
                      Fixes #${{ github.event.issue.number }}

                      This PR was automatically generated by Claude in response to the issue.
                  pr_labels: automated,claude
