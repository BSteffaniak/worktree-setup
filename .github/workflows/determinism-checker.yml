name: Determinism Checker

on:
    schedule:
        - cron: "0 6 * * 5" # Weekly Friday at 6 AM UTC
    workflow_dispatch:
        inputs:
            existing_branch:
                description: "Existing branch to use (empty to create new)"
                required: false
                type: string
                default: ""
            model:
                description: "Claude model to use"
                required: false
                type: string
                default: "claude-opus-4-20250514"

permissions:
    contents: write
    pull-requests: write

jobs:
    check-determinism:
        name: Check Determinism
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - uses: dtolnay/rust-toolchain@stable
              with:
                  components: rustfmt, clippy

            - name: Create branch
              id: branch
              uses: MoosicBox/MoosicBox/.github/actions/claude-checker@master
              with:
                  command: create-branch
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  branch_prefix: determinism-updates
                  branch_name: ${{ inputs.existing_branch }}
                  existing_branch: ${{ inputs.existing_branch != '' && 'true' || 'false' }}

            - name: Run determinism check with Claude
              uses: MoosicBox/MoosicBox/.github/actions/claude-checker@master
              with:
                  command: check
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  claude_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
                  prompt_template_file: .github/prompts/determinism-checker.md
                  branch_name: ${{ steps.branch.outputs.branch_name }}
                  auto_commit: true
                  enable_resilient_push: true
                  model: ${{ inputs.model || 'claude-opus-4-20250514' }}

            - name: Create PR
              uses: MoosicBox/MoosicBox/.github/actions/claude-checker@master
              with:
                  command: create-pr
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  branch_name: ${{ steps.branch.outputs.branch_name }}
                  pr_base_branch: master
                  pr_title: "Determinism Fixes: Replace HashMap/HashSet with BTreeMap/BTreeSet"
                  pr_body: |
                      This PR replaces non-deterministic collections with deterministic alternatives.

                      ## Changes
                      - Replaced `HashMap` with `BTreeMap`
                      - Replaced `HashSet` with `BTreeSet`

                      ## Why?
                      Per AGENTS.md, this project requires deterministic collection types to ensure:
                      - Consistent iteration order across runs
                      - Reproducible builds and tests
                      - Easier debugging

                      ---
                      *This PR was automatically generated by the Determinism Checker workflow.*
                  pr_labels: automated,determinism
