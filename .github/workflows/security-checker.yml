name: Security Checker

on:
    schedule:
        - cron: "0 6 * * 1" # Weekly Monday at 6 AM UTC
    workflow_dispatch:
        inputs:
            severity_threshold:
                description: "Minimum severity to report (low, medium, high, critical)"
                required: false
                type: choice
                options:
                    - low
                    - medium
                    - high
                    - critical
                default: "medium"
            existing_branch:
                description: "Existing branch to use (empty to create new)"
                required: false
                type: string
                default: ""
            model:
                description: "Claude model to use"
                required: false
                type: string
                default: "claude-opus-4-20250514"

permissions:
    contents: write
    pull-requests: write

jobs:
    security-audit:
        name: Security Audit
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - uses: dtolnay/rust-toolchain@stable

            - name: Install cargo-audit
              run: cargo install cargo-audit --locked

            - name: Create branch
              id: branch
              uses: MoosicBox/MoosicBox/.github/actions/claude-checker@master
              with:
                  command: create-branch
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  branch_prefix: security-updates
                  branch_name: ${{ inputs.existing_branch }}
                  existing_branch: ${{ inputs.existing_branch != '' && 'true' || 'false' }}

            - name: Run security audit with Claude
              uses: MoosicBox/MoosicBox/.github/actions/claude-checker@master
              with:
                  command: check
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  claude_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
                  prompt_template: security
                  template_vars: |
                      severity_threshold: ${{ inputs.severity_threshold || 'medium' }}
                  branch_name: ${{ steps.branch.outputs.branch_name }}
                  auto_commit: true
                  enable_resilient_push: true
                  model: ${{ inputs.model || 'claude-opus-4-20250514' }}

            - name: Create PR
              uses: MoosicBox/MoosicBox/.github/actions/claude-checker@master
              with:
                  command: create-pr
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  branch_name: ${{ steps.branch.outputs.branch_name }}
                  pr_base_branch: master
                  pr_title: "Security Audit Fixes"
                  pr_body: |
                      This PR contains security fixes identified by automated security audit.

                      ## Checks Performed
                      - Dependency vulnerability scanning (cargo-audit)
                      - Code pattern analysis for common security issues
                      - Unsafe code review
                      - Error handling audit

                      ---
                      *This PR was automatically generated by the Security Checker workflow.*
                  pr_labels: automated,security
