name: Unit Tests Checker

on:
    schedule:
        - cron: "0 10 * * 3" # Weekly Wednesday at 10 AM UTC
    workflow_dispatch:
        inputs:
            packages:
                description: "Comma-separated list of packages to check (empty for all)"
                required: false
                type: string
                default: ""
            existing_branch:
                description: "Existing branch to use (empty to create new)"
                required: false
                type: string
                default: ""
            model:
                description: "Claude model to use"
                required: false
                type: string
                default: "claude-opus-4-20250514"

permissions:
    contents: write
    pull-requests: write

jobs:
    determine-packages:
        name: Determine Packages
        runs-on: ubuntu-latest
        outputs:
            matrix: ${{ steps.packages.outputs.matrix }}
            branch-name: ${{ steps.branch.outputs.branch_name }}

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Create branch
              id: branch
              uses: MoosicBox/MoosicBox/.github/actions/claude-checker@master
              with:
                  command: create-branch
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  branch_prefix: unit-tests-updates
                  branch_name: ${{ inputs.existing_branch }}
                  existing_branch: ${{ inputs.existing_branch != '' && 'true' || 'false' }}

            - name: Get packages
              id: packages
              run: |
                  if [ -n "${{ inputs.packages }}" ]; then
                      PACKAGES=$(echo '${{ inputs.packages }}' | jq -R 'split(",") | map({name: ., path: "packages/\(.)"})')
                  else
                      PACKAGES=$(find packages -maxdepth 1 -mindepth 1 -type d | while read dir; do
                          name=$(basename "$dir")
                          echo "{\"name\": \"$name\", \"path\": \"$dir\"}"
                      done | jq -s '.')
                  fi
                  echo "matrix=$PACKAGES" >> $GITHUB_OUTPUT

    update-tests:
        name: Update Tests - ${{ matrix.package.name }}
        runs-on: ubuntu-latest
        needs: determine-packages
        strategy:
            fail-fast: false
            max-parallel: 1
            matrix:
                package: ${{ fromJson(needs.determine-packages.outputs.matrix) }}

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  ref: ${{ needs.determine-packages.outputs.branch-name }}

            - uses: dtolnay/rust-toolchain@stable

            - name: Update unit tests with Claude
              uses: MoosicBox/MoosicBox/.github/actions/claude-checker@master
              with:
                  command: check
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  claude_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
                  prompt_template: unit-tests
                  template_vars: |
                      package_name: ${{ matrix.package.name }}
                      package_path: ${{ matrix.package.path }}
                  branch_name: ${{ needs.determine-packages.outputs.branch-name }}
                  auto_commit: true
                  enable_resilient_push: true
                  model: ${{ inputs.model || 'claude-opus-4-20250514' }}

    create-pr:
        name: Create Pull Request
        runs-on: ubuntu-latest
        needs: [determine-packages, update-tests]
        if: always() && needs.update-tests.result == 'success'

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  ref: ${{ needs.determine-packages.outputs.branch-name }}

            - name: Create PR
              uses: MoosicBox/MoosicBox/.github/actions/claude-checker@master
              with:
                  command: create-pr
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  branch_name: ${{ needs.determine-packages.outputs.branch-name }}
                  pr_base_branch: master
                  pr_title: "Automated Unit Test Coverage Updates"
                  pr_body: |
                      This PR contains automated unit test updates generated by Claude.

                      ## Changes
                      - Added tests for untested code paths
                      - Improved test coverage for edge cases
                      - Added documentation for test cases

                      ---
                      *This PR was automatically generated by the Unit Tests Checker workflow.*
                  pr_labels: automated,testing
